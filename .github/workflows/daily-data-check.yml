name: Daily Data Validation

on:
  schedule:
    # 6:30 AM UTC = 12:30 AM CST (after Adveronix updates at 4:00 AM CST)
    - cron: '30 6 * * *'
  
  workflow_dispatch:  # Allow manual trigger
    inputs:
      notify:
        description: 'Send Discord notification even if passing'
        required: false
        default: 'false'

jobs:
  health-check:
    name: Health Check
    runs-on: ubuntu-latest
    
    steps:
      - name: Check API Health
        id: health
        run: |
          RESPONSE=$(curl -s -w "\n%{http_code}" https://qbtraining.ai/api/health)
          HTTP_CODE=$(echo "$RESPONSE" | tail -n1)
          BODY=$(echo "$RESPONSE" | sed '$d')
          
          echo "http_code=$HTTP_CODE" >> $GITHUB_OUTPUT
          echo "response=$BODY" >> $GITHUB_OUTPUT
          
          if [ "$HTTP_CODE" != "200" ]; then
            echo "‚ùå Health check failed with HTTP $HTTP_CODE"
            exit 1
          fi
          
          # Check if all endpoints are healthy
          FAILED=$(echo "$BODY" | jq -r '.summary.failed')
          if [ "$FAILED" != "0" ]; then
            echo "‚ùå $FAILED endpoints failed"
            exit 1
          fi
          
          echo "‚úÖ All endpoints healthy"

      - name: Send Discord notification (on failure)
        if: failure()
        run: |
          RESPONSE='${{ steps.health.outputs.response }}'
          FAILED_CHECKS=$(echo "$RESPONSE" | jq -r '.checks[] | select(.ok == false) | "- ‚ùå \(.name): \(.error // "Unknown error")"' | head -5)
          
          curl -H "Content-Type: application/json" \
            -d "{
              \"content\": \"üî¥ **Daily Data Check Failed**\n\n$FAILED_CHECKS\n\n<@&1466473853407465653> <@Vision> <@Professor> please investigate\n\nTime: $(date -u +\"%Y-%m-%d %H:%M UTC\")\",
              \"username\": \"Data Monitor\"
            }" \
            ${{ secrets.DISCORD_WEBHOOK_URL }}

  data-validation:
    name: Data Validation Tests
    runs-on: ubuntu-latest
    needs: health-check  # Only run if health check passes
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
      
      - name: Install dependencies
        run: npm ci
      
      - name: Run data validation tests
        id: tests
        run: |
          npm run test:data 2>&1 | tee test-output.txt
          TEST_EXIT_CODE=${PIPESTATUS[0]}
          
          echo "exit_code=$TEST_EXIT_CODE" >> $GITHUB_OUTPUT
          
          if [ "$TEST_EXIT_CODE" != "0" ]; then
            echo "‚ùå Data validation tests failed"
            exit 1
          fi
        env:
          NEXT_PUBLIC_BASE_URL: https://qbtraining.ai
      
      - name: Parse test results
        if: always()
        id: parse
        run: |
          if [ -f test-output.txt ]; then
            TESTS_RUN=$(grep -oP '\d+(?= tests)' test-output.txt | tail -1 || echo "0")
            TESTS_PASSED=$(grep -oP '\d+(?= passed)' test-output.txt | tail -1 || echo "0")
            TESTS_FAILED=$(grep -oP '\d+(?= failed)' test-output.txt | tail -1 || echo "0")
            
            echo "tests_run=$TESTS_RUN" >> $GITHUB_OUTPUT
            echo "tests_passed=$TESTS_PASSED" >> $GITHUB_OUTPUT
            echo "tests_failed=$TESTS_FAILED" >> $GITHUB_OUTPUT
          fi
      
      - name: Send Discord notification (on test failure)
        if: failure() && steps.tests.outcome == 'failure'
        run: |
          FAILED_TESTS=$(grep -A2 "FAIL" test-output.txt | head -20 || echo "See GitHub Actions for details")
          
          curl -H "Content-Type: application/json" \
            -d "{
              \"content\": \"‚ö†Ô∏è **Data Validation Tests Failed**\n\nTests run: ${{ steps.parse.outputs.tests_run }}\nPassed: ${{ steps.parse.outputs.tests_passed }}\nFailed: ${{ steps.parse.outputs.tests_failed }}\n\n\`\`\`\n${FAILED_TESTS}\n\`\`\`\n\n<@Vision> <@Professor> see details: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}\",
              \"username\": \"Data Validator\"
            }" \
            ${{ secrets.DISCORD_WEBHOOK_URL }}
      
      - name: Upload test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: test-results-${{ github.run_number }}
          path: test-output.txt
          retention-days: 30

  daily-summary:
    name: Daily Summary
    runs-on: ubuntu-latest
    needs: [health-check, data-validation]
    if: always()  # Run even if previous jobs failed
    
    steps:
      - name: Send daily summary to Discord
        if: github.event.inputs.notify == 'true' || success()
        run: |
          HEALTH_STATUS="${{ needs.health-check.result }}"
          TESTS_STATUS="${{ needs.data-validation.result }}"
          
          if [ "$HEALTH_STATUS" == "success" ] && [ "$TESTS_STATUS" == "success" ]; then
            STATUS_ICON="üü¢"
            STATUS_TEXT="All Green"
            COLOR="3066993"
          else
            STATUS_ICON="üî¥"
            STATUS_TEXT="Issues Found"
            COLOR="15158332"
          fi
          
          curl -H "Content-Type: application/json" \
            -d "{
              \"embeds\": [{
                \"title\": \"$STATUS_ICON Daily Data Check - $STATUS_TEXT\",
                \"color\": $COLOR,
                \"fields\": [
                  {
                    \"name\": \"API Health Check\",
                    \"value\": \"$HEALTH_STATUS\",
                    \"inline\": true
                  },
                  {
                    \"name\": \"Data Validation\",
                    \"value\": \"$TESTS_STATUS\",
                    \"inline\": true
                  },
                  {
                    \"name\": \"Timestamp\",
                    \"value\": \"$(date -u +\"%Y-%m-%d %H:%M UTC\")\",
                    \"inline\": false
                  }
                ],
                \"footer\": {
                  \"text\": \"Automated daily check\"
                }
              }],
              \"username\": \"Daily Monitor\"
            }" \
            ${{ secrets.DISCORD_WEBHOOK_URL }}
